{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}

{% block js %}
  <script src="{% static '/static/js/custom.js' %}"></script>
  <script src="{% static '/static/phaser/build/phaser.js' %}"></script>
  <!--<script src="{% static '/static/js/phaser-debug.js' %}"></script>-->
  <script src="{% static '/static/js/pywars/Player.js' %}"></script>
  <script src="{% static '/static/js/pywars/Level.js' %}"></script>
  <script type="text/javascript">
    var game = null;
    var gameData = [];
    var gameTimer = null;
    var turnEndTimer = null;
    var players = [];
    var level = null;
    var hud = null;
    var current_turn = null;
    var play_number = 0;

    function verifyTurnEnd(player) {
        if (player.busy == true) {
            console.log("player busy");
            return
        } else {
            current_turn = null;
            clearInterval(turnEndTimer);
        }
    }

    function turnsTimer() {
        if (gameData['actions'].length > 0) {
            if (current_turn != null) {
                return;
            }
            current_turn = gameData['actions'].shift();
            if (current_turn['action'] == 'make_move') {
                player = getPlayer(current_turn['player']);
                player.move(current_turn['position']);
                turnEndTimer = setInterval(function () {verifyTurnEnd(player)}, 1000);
                console.log(player);
                console.log(current_turn['action']);
            } else if (current_turn['action'] == 'make_shoot') {
                player = getPlayer(current_turn['player']);
                player.shoot(current_turn['speed'], current_turn['angle']);
                turnEndTimer = setInterval(function () {verifyTurnEnd(player)}, 1000);
            }
             else {
                console.log("turn action: " + current_turn);
                current_turn = null;
            }
        } else {
            console.log("end");
            clearInterval(gameTimer);
        }
    }

    function getPlayer(username) {
        for (i = 0; i < players.length; i++) {
            if (players[i].username == username) {
                console.log("moving player: "+ players[i].username);
                return players[i];
            }
        }
        return;
    }

    function startGame(data) {
        gameData = data;
        game = new Phaser.Game(800, 600, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });


        function preload()
        {
	        level = new Level(game);
            level.preload();

            for (var k in gameData['actions']) {
                playerData = gameData['actions'][k];
                if (playerData['action'] == 'new_player') {
                    var new_player = new Player(game, playerData['name'], playerData['position']);
                    new_player.preload();
                    players.push(new_player);
                }
            }
         //game.add.plugin(Phaser.Plugin.Debug);
        }

        function create()
        {
            level.create();
            for (playerK in players) {
                players[playerK].create();
            }
            //hud.create();
        }

        function update()
        {
            level.update();
            for (i = 0; i < players.length; i++) {
               players[i].update();
            }
        }
    }

    $(document).ready(function() {
        var jqxhr = $.get( "get_match", function(data) {
          if (data['success']) {
              startGame(data['data']);
              gameTimer = setInterval(function () {turnsTimer()}, 1000);
          }
        })
          .fail(function() {
            console.log("Failed to get match");
          });


    });
</script>
{% endblock %}

{% block content %}
    <div class="col-md-offset-1 main">
        <div class="row">
            <div id="header">
              <h1>Pywars Challenge</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8">
                <div id="game"></div>
            </div>
            <div class="col-md-4 playlist-box">
                <h3>Playlist</h3>
                <div id="div-playlist"></div>
            </div>
        </div>
    </div>
{% endblock %}
